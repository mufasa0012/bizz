import React, { useState, useEffect, createContext, useContext } from 'react';
import { initializeApp } from 'firebase/app';
import {
    getAuth,
    signInWithEmailAndPassword,
    createUserWithEmailAndPassword,
    onAuthStateChanged,
    signOut,
    signInAnonymously,
    signInWithCustomToken,
} from 'firebase/auth';
import {
    getFirestore,
    doc,
    setDoc,
    getDoc,
    collection,
    query,
    where,
    getDocs,
    addDoc,
    onSnapshot,
} from 'firebase/firestore';

// Context for Firebase and User Data
const AppContext = createContext();

export default function App() {
    const [db, setDb] = useState(null);
    const [auth, setAuth] = useState(null);
    const [currentUser, setCurrentUser] = useState(null);
    const [appId, setAppId] = useState('');
    const [userId, setUserId] = useState(null);
    const [loading, setLoading] = useState(true); // Initial loading for Firebase setup

    useEffect(() => {
        // Initialize Firebase
        try {
            const firebaseConfig = typeof __firebase_config !== 'undefined'
                ? JSON.parse(__firebase_config)
                : {}; // Fallback for local development
            const initializedApp = initializeApp(firebaseConfig);
            const firestoreDb = getFirestore(initializedApp);
            const firebaseAuth = getAuth(initializedApp);

            setDb(firestoreDb);
            setAuth(firebaseAuth);

            const currentAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            setAppId(currentAppId);

            // Handle authentication state changes
            const unsubscribe = onAuthStateChanged(firebaseAuth, async (user) => {
                if (user) {
                    setCurrentUser(user);
                    setUserId(user.uid);
                    // Fetch user details from Firestore
                    const userDocRef = doc(firestoreDb, `artifacts/${currentAppId}/public/data/users`, user.uid);
                    const userDocSnap = await getDoc(userDocRef);
                    if (userDocSnap.exists()) {
                        setCurrentUser(prev => ({ ...prev, ...userDocSnap.data() }));
                    } else {
                        // If user somehow exists in auth but not in Firestore, sign them out or create basic entry
                        console.warn("User exists in auth but not Firestore. Creating basic entry.");
                        // This case should ideally not happen if signup is handled correctly
                        await setDoc(userDocRef, {
                            email: user.email,
                            role: 'shopper', // Default role
                            associatedBusinesses: [],
                            createdAt: new Date(),
                        });
                        setCurrentUser(prev => ({ ...prev, role: 'shopper', associatedBusinesses: [] }));
                    }
                } else {
                    setCurrentUser(null);
                    setUserId(null);
                }
                setLoading(false); // Authentication state is ready
            });

            // Initial sign-in with custom token or anonymously
            const handleInitialAuth = async () => {
                if (typeof __initial_auth_token !== 'undefined') {
                    try {
                        await signInWithCustomToken(firebaseAuth, __initial_auth_token);
                    } catch (error) {
                        console.error('Error signing in with custom token:', error);
                        await signInAnonymously(firebaseAuth); // Fallback to anonymous
                    }
                } else {
                    await signInAnonymously(firebaseAuth);
                }
            };
            handleInitialAuth();

            return () => unsubscribe(); // Cleanup auth listener
        } catch (error) {
            console.error("Failed to initialize Firebase:", error);
            setLoading(false);
        }
    }, []); // Run once on component mount

    if (loading) {
        return <LoadingSpinner message="Initializing application..." />;
    }

    return (
        <AppContext.Provider value={{ db, auth, currentUser, appId, userId, setCurrentUser }}>
            <div className="min-h-screen bg-gray-100 flex flex-col font-inter">
                {currentUser ? <MainLayout /> : <Auth />}
            </div>
        </AppContext.Provider>
    );
}

// Reusable Loading Spinner Component
const LoadingSpinner = ({ message = "Loading..." }) => (
    <div className="flex items-center justify-center min-h-screen bg-gray-50">
        <div className="flex flex-col items-center p-6 bg-white rounded-lg shadow-xl">
            <svg className="animate-spin h-10 w-10 text-indigo-600 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p className="text-gray-700 text-lg">{message}</p>
        </div>
    </div>
);

// Auth Component (Login/Signup)
const Auth = () => {
    const { auth, db, appId, setCurrentUser } = useContext(AppContext);
    const [isLogin, setIsLogin] = useState(true);
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');
    const [businessName, setBusinessName] = useState('');
    const [businessType, setBusinessType] = useState('Shop');
    const [error, setError] = useState('');
    const [loading, setLoading] = useState(false);
    const [message, setMessage] = useState(''); // For success messages

    const handleAuth = async (e) => {
        e.preventDefault();
        setError('');
        setMessage('');
        setLoading(true);

        try {
            if (isLogin) {
                // Login
                await signInWithEmailAndPassword(auth, email, password);
                setMessage('Successfully logged in!');
            } else {
                // Signup
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                const userId = user.uid;

                // Create a public user document in Firestore
                const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, userId);
                await setDoc(userDocRef, {
                    email: email,
                    role: 'owner', // New users sign up as owners
                    associatedBusinesses: [],
                    createdAt: new Date(),
                });

                // If signing up as a business owner, create a new business
                const businessDocRef = collection(db, `artifacts/${appId}/public/data/businesses`);
                const newBusiness = {
                    name: businessName,
                    type: businessType,
                    ownerId: userId,
                    createdAt: new Date(),
                };
                const docRef = await addDoc(businessDocRef, newBusiness);
                const businessId = docRef.id;

                // Update the user's document to associate the new business
                await setDoc(userDocRef, {
                    associatedBusinesses: [{ id: businessId, name: businessName, type: businessType }],
                }, { merge: true });

                // Update current user context
                setCurrentUser(prev => ({
                    ...prev,
                    role: 'owner',
                    associatedBusinesses: [{ id: businessId, name: businessName, type: businessType }],
                }));

                setMessage('Account created and business registered successfully!');
            }
        } catch (err) {
            console.error("Auth error:", err);
            setError(err.message);
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="flex items-center justify-center min-h-screen bg-gradient-to-br from-indigo-500 to-purple-600 p-4">
            <div className="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
                <h2 className="text-3xl font-bold text-center text-gray-800 mb-6">
                    {isLogin ? 'Login' : 'Sign Up'}
                </h2>
                <form onSubmit={handleAuth} className="space-y-5">
                    <div>
                        <label className="block text-gray-700 text-sm font-medium mb-2" htmlFor="email">
                            Email
                        </label>
                        <input
                            type="email"
                            id="email"
                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out"
                            placeholder="your@example.com"
                            value={email}
                            onChange={(e) => setEmail(e.target.value)}
                            required
                        />
                    </div>
                    <div>
                        <label className="block text-gray-700 text-sm font-medium mb-2" htmlFor="password">
                            Password
                        </label>
                        <input
                            type="password"
                            id="password"
                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out"
                            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                            value={password}
                            onChange={(e) => setPassword(e.target.value)}
                            required
                        />
                    </div>

                    {!isLogin && (
                        <>
                            <div>
                                <label className="block text-gray-700 text-sm font-medium mb-2" htmlFor="businessName">
                                    Business Name
                                </label>
                                <input
                                    type="text"
                                    id="businessName"
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out"
                                    placeholder="My Awesome Business"
                                    value={businessName}
                                    onChange={(e) => setBusinessName(e.target.value)}
                                    required={!isLogin}
                                />
                            </div>
                            <div>
                                <label className="block text-gray-700 text-sm font-medium mb-2" htmlFor="businessType">
                                    Business Type
                                </label>
                                <select
                                    id="businessType"
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out"
                                    value={businessType}
                                    onChange={(e) => setBusinessType(e.target.value)}
                                    required={!isLogin}
                                >
                                    <option value="Shop">Shop</option>
                                    <option value="Chemist">Chemist</option>
                                    <option value="Hotel">Hotel</option>
                                    <option value="Supermarket">Supermarket</option>
                                    <option value="Wholesale">Wholesale</option>
                                    <option value="Retail">Retail</option>
                                </select>
                            </div>
                        </>
                    )}

                    {error && <p className="text-red-600 text-sm text-center">{error}</p>}
                    {message && <p className="text-green-600 text-sm text-center">{message}</p>}

                    <button
                        type="submit"
                        className="w-full bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50 transition duration-200 ease-in-out font-semibold text-lg"
                        disabled={loading}
                    >
                        {loading ? <LoadingSpinner message="Processing..." /> : (isLogin ? 'Login' : 'Sign Up')}
                    </button>
                </form>

                <p className="mt-6 text-center text-gray-600">
                    {isLogin ? "Don't have an account?" : "Already have an account?"}{' '}
                    <button
                        onClick={() => {
                            setIsLogin(!isLogin);
                            setError('');
                            setMessage('');
                        }}
                        className="text-indigo-600 hover:text-indigo-800 font-medium transition duration-150 ease-in-out"
                    >
                        {isLogin ? 'Sign Up' : 'Login'}
                    </button>
                </p>
            </div>
        </div>
    );
};

// Main Layout Component
const MainLayout = () => {
    const { auth, currentUser, appId, userId, db, setCurrentUser } = useContext(AppContext);
    const [currentView, setCurrentView] = useState('Dashboard');
    const [selectedBusinessId, setSelectedBusinessId] = useState(null);
    const [selectedBusiness, setSelectedBusiness] = useState(null);
    const [businessesLoading, setBusinessesLoading] = useState(true);
    const [businesses, setBusinesses] = useState([]);

    useEffect(() => {
        // Fetch businesses associated with the user
        const fetchBusinesses = async () => {
            if (!currentUser || !currentUser.associatedBusinesses || currentUser.associatedBusinesses.length === 0) {
                setBusinesses([]);
                setSelectedBusiness(null);
                setSelectedBusinessId(null);
                setBusinessesLoading(false);
                return;
            }

            try {
                // For 'owner' role, fetch businesses they own
                if (currentUser.role === 'owner') {
                    const q = query(
                        collection(db, `artifacts/${appId}/public/data/businesses`),
                        where('ownerId', '==', currentUser.uid)
                    );
                    const querySnapshot = await getDocs(q);
                    const ownerBusinesses = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setBusinesses(ownerBusinesses);
                    if (ownerBusinesses.length > 0) {
                        setSelectedBusinessId(ownerBusinesses[0].id);
                        setSelectedBusiness(ownerBusinesses[0]);
                    } else {
                        setSelectedBusinessId(null);
                        setSelectedBusiness(null);
                    }
                } else {
                    // For 'shopper' or other roles, if they have associated businesses in their user profile
                    const associated = currentUser.associatedBusinesses.map(b => b.id);
                    if (associated.length > 0) {
                        const q = query(
                            collection(db, `artifacts/${appId}/public/data/businesses`),
                            where('__name__', 'in', associated) // Use __name__ for document ID lookup
                        );
                        const querySnapshot = await getDocs(q);
                        const fetchedBusinesses = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setBusinesses(fetchedBusinesses);
                        if (fetchedBusinesses.length > 0) {
                            setSelectedBusinessId(fetchedBusinesses[0].id);
                            setSelectedBusiness(fetchedBusinesses[0]);
                        } else {
                            setSelectedBusinessId(null);
                            setSelectedBusiness(null);
                        }
                    } else {
                        setBusinesses([]);
                        setSelectedBusiness(null);
                        setSelectedBusinessId(null);
                    }
                }
            } catch (error) {
                console.error("Error fetching businesses:", error);
            } finally {
                setBusinessesLoading(false);
            }
        };

        if (currentUser && currentUser.uid && db && appId) {
            fetchBusinesses();
        }
    }, [currentUser, db, appId]);

    const handleLogout = async () => {
        try {
            await signOut(auth);
        } catch (error) {
            console.error("Error logging out:", error);
        }
    };

    const navItems = [
        { name: 'Dashboard', roles: ['owner', 'employee', 'shopper'] },
        { name: 'ERP System', roles: ['owner', 'employee'] },
        { name: 'Accounting', roles: ['owner', 'employee'] },
        { name: 'CRM Software', roles: ['owner', 'employee'] },
        { name: 'POS System', roles: ['owner', 'employee'] },
        { name: 'AI Assistant', roles: ['owner', 'employee', 'shopper'] },
    ];

    const businessTypeSpecificModules = {
        'Shop': { name: 'Shop Module', component: ShopModule, roles: ['owner', 'employee'] },
        'Chemist': { name: 'Chemist Module', component: ChemistModule, roles: ['owner', 'employee'] },
        'Hotel': { name: 'Hotel Module', component: HotelModule, roles: ['owner', 'employee'] },
        'Supermarket': { name: 'Supermarket Module', component: SupermarketModule, roles: ['owner', 'employee'] },
        'Wholesale': { name: 'Wholesale Module', component: WholesaleModule, roles: ['owner', 'employee'] },
        'Retail': { name: 'Retail Module', component: RetailModule, roles: ['owner', 'employee'] },
    };

    // Filter nav items based on user role
    const filteredNavItems = navItems.filter(item =>
        item.roles.includes(currentUser?.role)
    );

    // Add business-specific module if a business is selected and matches
    if (selectedBusiness && businessTypeSpecificModules[selectedBusiness.type] &&
        businessTypeSpecificModules[selectedBusiness.type].roles.includes(currentUser?.role)) {
        const moduleName = businessTypeSpecificModules[selectedBusiness.type].name;
        if (!filteredNavItems.some(item => item.name === moduleName)) {
            filteredNavItems.splice(1, 0, { name: moduleName, roles: businessTypeSpecificModules[selectedBusiness.type].roles }); // Insert after Dashboard
        }
    }


    const renderContent = () => {
        const commonProps = { userId, appId, db, selectedBusinessId, selectedBusiness };
        switch (currentView) {
            case 'Dashboard':
                return <Dashboard {...commonProps} />;
            case 'ERP System':
                return <ERPSystem {...commonProps} />;
            case 'Accounting':
                return <AccountingSoftware {...commonProps} />;
            case 'CRM Software':
                return <CRMSoftware {...commonProps} />;
            case 'POS System':
                return <POSSystem {...commonProps} />;
            case 'AI Assistant':
                return <AIAssistant {...commonProps} />;
            case 'Shop Module':
                return <ShopModule {...commonProps} />;
            case 'Chemist Module':
                return <ChemistModule {...commonProps} />;
            case 'Hotel Module':
                return <HotelModule {...commonProps} />;
            case 'Supermarket Module':
                return <SupermarketModule {...commonProps} />;
            case 'Wholesale Module':
                return <WholesaleModule {...commonProps} />;
            case 'Retail Module':
                return <RetailModule {...commonProps} />;
            default:
                return <Dashboard {...commonProps} />;
        }
    };

    if (businessesLoading) {
        return <LoadingSpinner message="Loading businesses..." />;
    }

    return (
        <div className="flex flex-col h-screen w-full bg-gray-100">
            {/* Header */}
            <header className="bg-indigo-700 text-white p-4 shadow-md flex items-center justify-between z-10">
                <h1 className="text-2xl font-bold">Multi-Business Management System</h1>
                <div className="flex items-center space-x-4">
                    <span className="text-sm font-medium">Logged in as: {currentUser?.email || 'N/A'} ({currentUser?.role || 'N/A'})</span>
                    <span className="text-sm font-medium">User ID: {userId}</span>
                    <button
                        onClick={handleLogout}
                        className="bg-indigo-600 hover:bg-indigo-800 text-white font-semibold py-2 px-4 rounded-md shadow-sm transition duration-200"
                    >
                        Logout
                    </button>
                </div>
            </header>

            <div className="flex flex-1 overflow-hidden">
                {/* Sidebar */}
                <aside className="w-64 bg-indigo-800 text-white p-4 shadow-lg overflow-y-auto hidden md:block">
                    {currentUser?.role === 'owner' && (
                        <div className="mb-6">
                            <label className="block text-sm font-medium text-indigo-200 mb-2" htmlFor="businessSelect">
                                Select Business:
                            </label>
                            <select
                                id="businessSelect"
                                className="w-full p-2 rounded-md bg-indigo-700 border border-indigo-600 text-white text-sm focus:ring-indigo-500 focus:border-indigo-500"
                                value={selectedBusinessId || ''}
                                onChange={(e) => {
                                    const id = e.target.value;
                                    setSelectedBusinessId(id);
                                    setSelectedBusiness(businesses.find(b => b.id === id));
                                }}
                            >
                                {businesses.length === 0 ? (
                                    <option value="" disabled>No businesses found</option>
                                ) : (
                                    businesses.map(business => (
                                        <option key={business.id} value={business.id}>
                                            {business.name} ({business.type})
                                        </option>
                                    ))
                                )}
                            </select>
                        </div>
                    )}

                    <nav className="space-y-2">
                        {filteredNavItems.map((item) => (
                            <button
                                key={item.name}
                                onClick={() => setCurrentView(item.name)}
                                className={`w-full text-left py-2 px-3 rounded-lg flex items-center space-x-3 transition duration-200 ease-in-out
                                    ${currentView === item.name ? 'bg-indigo-600 text-white font-semibold shadow-md' : 'hover:bg-indigo-700 text-indigo-100'}
                                `}
                            >
                                {item.name === 'Dashboard' && <span className="text-xl">üìä</span>}
                                {item.name === 'ERP System' && <span className="text-xl">‚öôÔ∏è</span>}
                                {item.name === 'Accounting' && <span className="text-xl">üí∞</span>}
                                {item.name === 'CRM Software' && <span className="text-xl">ü§ù</span>}
                                {item.name === 'POS System' && <span className="text-xl">üõí</span>}
                                {item.name === 'AI Assistant' && <span className="text-xl">ü§ñ</span>}
                                {item.name.includes('Module') && <span className="text-xl">üè¢</span>}
                                <span>{item.name}</span>
                            </button>
                        ))}
                    </nav>
                </aside>

                {/* Main Content Area */}
                <main className="flex-1 p-6 overflow-y-auto">
                    {renderContent()}
                </main>
            </div>

            {/* Footer */}
            <footer className="bg-gray-800 text-white p-4 text-center text-sm shadow-inner z-10">
                <div className="container mx-auto">
                    <p>&copy; 2025 Multi-Business Management System. All rights reserved.</p>
                    <p className="mt-1">
                        Local Compliance & Tax Information: This system helps manage local tax data. Please consult with a local tax professional for specific compliance requirements in your region.
                        <a href="#tax-details" className="text-indigo-400 hover:underline ml-2">Learn More</a>
                    </p>
                </div>
            </footer>
        </div>
    );
};

// --- Module Components (Placeholders) ---

const ModuleContainer = ({ title, children }) => (
    <div className="bg-white p-6 rounded-lg shadow-xl mb-6">
        <h2 className="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">{title}</h2>
        {children}
    </div>
);

const Dashboard = ({ currentUser, selectedBusiness }) => {
    return (
        <ModuleContainer title="Dashboard">
            <p className="text-lg text-gray-700 mb-4">
                Welcome, <span className="font-semibold">{currentUser?.email || 'User'}</span>!
                You are currently viewing the dashboard for:
                <span className="font-semibold ml-1">
                    {selectedBusiness ? `${selectedBusiness.name} (${selectedBusiness.type})` : 'No Business Selected'}
                </span>
            </p>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div className="bg-indigo-100 p-4 rounded-lg shadow-sm">
                    <h3 className="font-semibold text-lg text-indigo-800 mb-2">Total Sales (Placeholder)</h3>
                    <p className="text-3xl font-bold text-indigo-700">$12,345.67</p>
                    <p className="text-sm text-gray-600 mt-2">Last 30 days</p>
                </div>
                <div className="bg-green-100 p-4 rounded-lg shadow-sm">
                    <h3 className="font-semibold text-lg text-green-800 mb-2">Active Customers (Placeholder)</h3>
                    <p className="text-3xl font-bold text-green-700">85</p>
                    <p className="text-sm text-gray-600 mt-2">Current month</p>
                </div>
                <div className="bg-yellow-100 p-4 rounded-lg shadow-sm">
                    <h3 className="font-semibold text-lg text-yellow-800 mb-2">Pending Orders (Placeholder)</h3>
                    <p className="text-3xl font-bold text-yellow-700">12</p>
                    <p className="text-sm text-gray-600 mt-2">Needs action</p>
                </div>
            </div>
            <p className="mt-6 text-gray-600">
                This dashboard provides a high-level overview of key metrics specific to your selected business.
                Further details are available in the respective system modules.
            </p>
        </ModuleContainer>
    );
};

const ERPSystem = () => (
    <ModuleContainer title="ERP System">
        <p className="text-gray-700">
            This section represents the Enterprise Resource Planning (ERP) module.
            It would integrate core business processes like inventory management, procurement,
            supply chain, and basic HR functions.
        </p>
        <div className="mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
            <h3 className="font-semibold text-blue-800 mb-2">Key ERP Features:</h3>
            <ul className="list-disc list-inside text-blue-700 space-y-1">
                <li>Centralized Inventory Management</li>
                <li>Purchase Order Generation</li>
                <li>Supplier Management</li>
                <li>Basic HR & Employee Records</li>
                <li>Production Planning (if applicable)</li>
            </ul>
        </div>
    </ModuleContainer>
);

const AccountingSoftware = () => (
    <ModuleContainer title="Accounting Software">
        <p className="text-gray-700">
            This module handles all financial transactions and reporting for your business.
        </p>
        <div className="mt-4 p-4 bg-green-50 rounded-lg border border-green-200">
            <h3 className="font-semibold text-green-800 mb-2">Key Accounting Features:</h3>
            <ul className="list-disc list-inside text-green-700 space-y-1">
                <li>General Ledger & Chart of Accounts</li>
                <li>Accounts Receivable (Invoicing)</li>
                <li>Accounts Payable (Bill Management)</li>
                <li>Bank Reconciliation</li>
                <li>Financial Reports (P&L, Balance Sheet, Cash Flow)</li>
            </ul>
        </div>
    </ModuleContainer>
);

const CRMSoftware = () => (
    <ModuleContainer title="CRM Software">
        <p className="text-gray-700">
            Manage your customer relationships, sales leads, and marketing campaigns from here.
        </p>
        <div className="mt-4 p-4 bg-purple-50 rounded-lg border border-purple-200">
            <h3 className="font-semibold text-purple-800 mb-2">Key CRM Features:</h3>
            <ul className="list-disc list-inside text-purple-700 space-y-1">
                <li>Customer Database & Profiles</li>
                <li>Lead & Opportunity Management</li>
                <li>Marketing Automation (email campaigns)</li>
                <li>Customer Service & Support Ticketing</li>
                <li>Loyalty Program Integration</li>
            </ul>
        </div>
    </ModuleContainer>
);

const POSSystem = () => (
    <ModuleContainer title="POS System">
        <p className="text-gray-700">
            The Point of Sale (POS) system for processing sales transactions.
        </p>
        <div className="mt-4 p-4 bg-yellow-50 rounded-lg border border-yellow-200">
            <h3 className="font-semibold text-yellow-800 mb-2">Key POS Features:</h3>
            <ul className="list-disc list-inside text-yellow-700 space-y-1">
                <li>Sales Transaction Processing (cash, card)</li>
                <li>Barcode Scanning</li>
                <li>Receipt Generation</li>
                <li>Real-time Inventory Updates</li>
                <li>Daily Sales Reports</li>
            </ul>
        </div>
    </ModuleContainer>
);

const AIAssistant = ({ userId, db, appId, selectedBusinessId, selectedBusiness }) => {
    const [messages, setMessages] = useState([]);
    const [input, setInput] = useState('');
    const [aiLoading, setAiLoading] = useState(false);
    const messagesEndRef = React.useRef(null);

    const scrollToBottom = () => {
        messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
    };

    useEffect(scrollToBottom, [messages]);

    const handleSendMessage = async () => {
        if (!input.trim()) return;

        const userMessage = { sender: 'user', text: input };
        setMessages((prevMessages) => [...prevMessages, userMessage]);
        setInput('');
        setAiLoading(true);

        try {
            // Construct a more informative prompt
            let prompt = `You are BizBuddy AI, an assistant for a business management system.
            The current user ID is ${userId}.
            The current business selected is: ${selectedBusiness ? `${selectedBusiness.name} (${selectedBusiness.type}, ID: ${selectedBusinessId})` : 'N/A (No business selected or user is a shopper)'}.
            
            Based on the context above, respond to the following user query: "${input}".
            Keep your response concise and helpful. If asked for data, describe what kind of data you would provide (e.g., "I would provide a list of top-selling products..."). If asked for system actions, describe what the system would do (e.g., "The system would process the sale..."). Do not generate actual data or perform actions. Focus on explaining capabilities or providing general advice.
            `;

            // Call the Gemini API
            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            const payload = { contents: chatHistory };
            const apiKey = ""; // Canvas will provide this in runtime

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await response.json();

            if (result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0) {
                const aiResponseText = result.candidates[0].content.parts[0].text;
                setMessages((prevMessages) => [...prevMessages, { sender: 'ai', text: aiResponseText }]);
            } else {
                setMessages((prevMessages) => [...prevMessages, { sender: 'ai', text: "Sorry, I couldn't process that. Please try again." }]);
                console.error("AI response structure unexpected:", result);
            }
        } catch (error) {
            console.error("Error communicating with AI:", error);
            setMessages((prevMessages) => [...prevMessages, { sender: 'ai', text: "There was an error connecting to the AI. Please try again later." }]);
        } finally {
            setAiLoading(false);
        }
    };

    return (
        <ModuleContainer title="BizBuddy AI Assistant">
            <div className="flex flex-col h-[60vh] bg-gray-50 rounded-lg shadow-inner overflow-hidden">
                <div className="flex-1 p-4 overflow-y-auto space-y-4">
                    {messages.length === 0 && (
                        <p className="text-center text-gray-500 italic mt-10">
                            Ask BizBuddy anything about your business or system capabilities!
                        </p>
                    )}
                    {messages.map((msg, index) => (
                        <div
                            key={index}
                            className={`flex ${msg.sender === 'user' ? 'justify-end' : 'justify-start'}`}
                        >
                            <div
                                className={`max-w-[70%] p-3 rounded-lg shadow-md ${
                                    msg.sender === 'user'
                                        ? 'bg-indigo-600 text-white rounded-br-none'
                                        : 'bg-gray-200 text-gray-800 rounded-bl-none'
                                }`}
                            >
                                {msg.text}
                            </div>
                        </div>
                    ))}
                    {aiLoading && (
                        <div className="flex justify-start">
                            <div className="max-w-[70%] p-3 rounded-lg shadow-md bg-gray-200 text-gray-800 rounded-bl-none">
                                <span className="animate-pulse">Typing...</span>
                            </div>
                        </div>
                    )}
                    <div ref={messagesEndRef} />
                </div>
                <div className="p-4 border-t border-gray-200 flex items-center">
                    <input
                        type="text"
                        className="flex-1 px-4 py-2 border border-gray-300 rounded-full focus:ring-indigo-500 focus:border-indigo-500 mr-3"
                        placeholder="Type your message..."
                        value={input}
                        onChange={(e) => setInput(e.target.value)}
                        onKeyPress={(e) => e.key === 'Enter' && handleSendMessage()}
                        disabled={aiLoading}
                    />
                    <button
                        onClick={handleSendMessage}
                        className="bg-indigo-600 text-white p-3 rounded-full hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50 transition duration-200 flex items-center justify-center"
                        disabled={aiLoading}
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M14 5l7 7m0 0l-7 7m7-7H3" />
                        </svg>
                    </button>
                </div>
            </div>
        </ModuleContainer>
    );
};

// Business Specific Modules (Placeholders)

const ShopModule = ({ db, appId, selectedBusinessId, userId }) => {
    const [products, setProducts] = useState([]);
    const [productName, setProductName] = useState('');
    const [productPrice, setProductPrice] = useState('');
    const [productStock, setProductStock] = useState('');
    const [loadingProducts, setLoadingProducts] = useState(true);

    const productsCollectionRef = selectedBusinessId
        ? collection(db, `artifacts/${appId}/public/data/businesses/${selectedBusinessId}/products`)
        : null;

    useEffect(() => {
        if (!productsCollectionRef) {
            setLoadingProducts(false);
            return;
        }

        const unsubscribe = onSnapshot(productsCollectionRef, (snapshot) => {
            const fetchedProducts = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            setProducts(fetchedProducts);
            setLoadingProducts(false);
        }, (error) => {
            console.error("Error fetching products:", error);
            setLoadingProducts(false);
        });

        return () => unsubscribe();
    }, [productsCollectionRef]);

    const handleAddProduct = async () => {
        if (!productName || !productPrice || !productStock || !productsCollectionRef) {
            alert('Please fill all product fields.'); // Using custom modal in real app
            return;
        }
        try {
            await addDoc(productsCollectionRef, {
                name: productName,
                price: parseFloat(productPrice),
                stock: parseInt(productStock),
                createdAt: new Date(),
                updatedBy: userId,
            });
            setProductName('');
            setProductPrice('');
            setProductStock('');
        } catch (error) {
            console.error("Error adding product:", error);
        }
    };

    return (
        <ModuleContainer title="Shop Management Module">
            <p className="text-gray-700 mb-4">Manage your shop's products, inventory, and sales specific functionalities here.</p>

            <div className="mb-6 p-4 bg-indigo-50 rounded-lg shadow-sm">
                <h3 className="text-lg font-semibold text-indigo-800 mb-3">Add New Product</h3>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <input
                        type="text"
                        placeholder="Product Name"
                        className="p-2 border rounded-md"
                        value={productName}
                        onChange={(e) => setProductName(e.target.value)}
                    />
                    <input
                        type="number"
                        placeholder="Price"
                        className="p-2 border rounded-md"
                        value={productPrice}
                        onChange={(e) => setProductPrice(e.target.value)}
                        step="0.01"
                    />
                    <input
                        type="number"
                        placeholder="Stock"
                        className="p-2 border rounded-md"
                        value={productStock}
                        onChange={(e) => setProductStock(e.target.value)}
                    />
                </div>
                <button
                    onClick={handleAddProduct}
                    className="mt-4 bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 transition duration-200"
                    disabled={!selectedBusinessId}
                >
                    Add Product
                </button>
                {!selectedBusinessId && <p className="text-red-500 text-sm mt-2">Please select a business to add products.</p>}
            </div>

            <h3 className="text-xl font-semibold text-gray-800 mb-3">Current Products</h3>
            {loadingProducts ? (
                <LoadingSpinner message="Fetching products..." />
            ) : products.length === 0 ? (
                <p className="text-gray-600">No products found for this shop. Add some above!</p>
            ) : (
                <div className="overflow-x-auto rounded-lg shadow">
                    <table className="min-w-full bg-white">
                        <thead className="bg-gray-200 text-gray-700">
                            <tr>
                                <th className="py-3 px-4 text-left">Name</th>
                                <th className="py-3 px-4 text-left">Price</th>
                                <th className="py-3 px-4 text-left">Stock</th>
                            </tr>
                        </thead>
                        <tbody>
                            {products.map((product) => (
                                <tr key={product.id} className="border-b border-gray-100 last:border-b-0 hover:bg-gray-50">
                                    <td className="py-3 px-4">{product.name}</td>
                                    <td className="py-3 px-4">${product.price?.toFixed(2)}</td>
                                    <td className="py-3 px-4">{product.stock}</td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            )}
        </ModuleContainer>
    );
};

const ChemistModule = ({ db, appId, selectedBusinessId, userId }) => {
    const [drugs, setDrugs] = useState([]);
    const [drugName, setDrugName] = useState('');
    const [strength, setStrength] = useState('');
    const [expiryDate, setExpiryDate] = useState('');
    const [stock, setStock] = useState('');
    const [controlled, setControlled] = useState(false);
    const [loadingDrugs, setLoadingDrugs] = useState(true);

    const drugsCollectionRef = selectedBusinessId
        ? collection(db, `artifacts/${appId}/public/data/businesses/${selectedBusinessId}/drugs`)
        : null;

    useEffect(() => {
        if (!drugsCollectionRef) {
            setLoadingDrugs(false);
            return;
        }

        const unsubscribe = onSnapshot(drugsCollectionRef, (snapshot) => {
            const fetchedDrugs = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            setDrugs(fetchedDrugs);
            setLoadingDrugs(false);
        }, (error) => {
            console.error("Error fetching drugs:", error);
            setLoadingDrugs(false);
        });

        return () => unsubscribe();
    }, [drugsCollectionRef]);


    const handleAddDrug = async () => {
        if (!drugName || !strength || !expiryDate || !stock || !drugsCollectionRef) {
            alert('Please fill all drug fields.'); // Using custom modal in real app
            return;
        }
        try {
            await addDoc(drugsCollectionRef, {
                name: drugName,
                strength: strength,
                expiryDate: expiryDate,
                stock: parseInt(stock),
                controlledSubstance: controlled,
                createdAt: new Date(),
                updatedBy: userId,
            });
            setDrugName('');
            setStrength('');
            setExpiryDate('');
            setStock('');
            setControlled(false);
        } catch (error) {
            console.error("Error adding drug:", error);
        }
    };

    return (
        <ModuleContainer title="Chemist Management Module">
            <p className="text-gray-700 mb-4">Manage your pharmacy's drug inventory, prescriptions, and patient records here.</p>

            <div className="mb-6 p-4 bg-green-50 rounded-lg shadow-sm">
                <h3 className="text-lg font-semibold text-green-800 mb-3">Add New Drug</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <input
                        type="text"
                        placeholder="Drug Name"
                        className="p-2 border rounded-md"
                        value={drugName}
                        onChange={(e) => setDrugName(e.target.value)}
                    />
                    <input
                        type="text"
                        placeholder="Strength (e.g., 500mg)"
                        className="p-2 border rounded-md"
                        value={strength}
                        onChange={(e) => setStrength(e.target.value)}
                    />
                    <input
                        type="date"
                        placeholder="Expiry Date"
                        className="p-2 border rounded-md"
                        value={expiryDate}
                        onChange={(e) => setExpiryDate(e.target.value)}
                    />
                    <input
                        type="number"
                        placeholder="Stock Quantity"
                        className="p-2 border rounded-md"
                        value={stock}
                        onChange={(e) => setStock(e.target.value)}
                    />
                    <div className="flex items-center space-x-2">
                        <input
                            type="checkbox"
                            id="controlled"
                            className="h-5 w-5 text-green-600 rounded"
                            checked={controlled}
                            onChange={(e) => setControlled(e.target.checked)}
                        />
                        <label htmlFor="controlled" className="text-gray-700">Controlled Substance</label>
                    </div>
                </div>
                <button
                    onClick={handleAddDrug}
                    className="mt-4 bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition duration-200"
                    disabled={!selectedBusinessId}
                >
                    Add Drug
                </button>
                {!selectedBusinessId && <p className="text-red-500 text-sm mt-2">Please select a business to add drugs.</p>}
            </div>

            <h3 className="text-xl font-semibold text-gray-800 mb-3">Current Drug Inventory</h3>
            {loadingDrugs ? (
                <LoadingSpinner message="Fetching drugs..." />
            ) : drugs.length === 0 ? (
                <p className="text-gray-600">No drugs found for this chemist. Add some above!</p>
            ) : (
                <div className="overflow-x-auto rounded-lg shadow">
                    <table className="min-w-full bg-white">
                        <thead className="bg-gray-200 text-gray-700">
                            <tr>
                                <th className="py-3 px-4 text-left">Name</th>
                                <th className="py-3 px-4 text-left">Strength</th>
                                <th className="py-3 px-4 text-left">Expiry Date</th>
                                <th className="py-3 px-4 text-left">Stock</th>
                                <th className="py-3 px-4 text-left">Controlled</th>
                            </tr>
                        </thead>
                        <tbody>
                            {drugs.map((drug) => (
                                <tr key={drug.id} className="border-b border-gray-100 last:border-b-0 hover:bg-gray-50">
                                    <td className="py-3 px-4">{drug.name}</td>
                                    <td className="py-3 px-4">{drug.strength}</td>
                                    <td className="py-3 px-4">{drug.expiryDate}</td>
                                    <td className="py-3 px-4">{drug.stock}</td>
                                    <td className="py-3 px-4">{drug.controlledSubstance ? 'Yes' : 'No'}</td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            )}
        </ModuleContainer>
    );
};

const HotelModule = () => (
    <ModuleContainer title="Hotel Management Module">
        <p className="text-gray-700">Manage reservations, guest check-ins, room status, and housekeeping for your hotel here.</p>
        <div className="mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
            <h3 className="font-semibold text-blue-800 mb-2">Key Hotel Features:</h3>
            <ul className="list-disc list-inside text-blue-700 space-y-1">
                <li>Room Reservation & Availability</li>
                <li>Guest Check-in/Check-out</li>
                <li>Room Service Management</li>
                <li>Housekeeping Schedules</li>
                <li>Billing & Guest Folios</li>
            </ul>
        </div>
    </ModuleContainer>
);

const SupermarketModule = () => (
    <ModuleContainer title="Supermarket Management Module">
        <p className="text-gray-700">Handle large-scale inventory, category management, and high-volume sales for your supermarket.</p>
        <div className="mt-4 p-4 bg-pink-50 rounded-lg border border-pink-200">
            <h3 className="font-semibold text-pink-800 mb-2">Key Supermarket Features:</h3>
            <ul className="list-disc list-inside text-pink-700 space-y-1">
                <li>Extensive Inventory & Shelf Management</li>
                <li>Supplier & Purchase Order Automation</li>
                <li>Scalable POS with Self-Checkout Options</li>
                <li>Promotions & Loyalty Programs</li>
            </ul>
        </div>
    </ModuleContainer>
);

const WholesaleModule = () => (
    <ModuleContainer title="Wholesale Management Module">
        <p className="text-gray-700">Manage bulk orders, B2B customer relationships, and sales representative performance for your wholesale business.</p>
        <div className="mt-4 p-4 bg-teal-50 rounded-lg border border-teal-200">
            <h3 className="font-semibold text-teal-800 mb-2">Key Wholesale Features:</h3>
            <ul className="list-disc list-inside text-teal-700 space-y-1">
                <li>Bulk Order & Tiered Pricing</li>
                <li>B2B Customer Portal</li>
                <li>Sales Representative Tracking</li>
                <li>Freight & Logistics Coordination</li>
            </ul>
        </div>
    </ModuleContainer>
);

const RetailModule = () => (
    <ModuleContainer title="Retail Management Module">
        <p className="text-gray-700">Specific tools for managing a general retail business, focusing on customer experience and sales.</p>
        <div className="mt-4 p-4 bg-orange-50 rounded-lg border border-orange-200">
            <h3 className="font-semibold text-orange-800 mb-2">Key Retail Features:</h3>
            <ul className="list-disc list-inside text-orange-700 space-y-1">
                <li>Product Catalog Management</li>
                <li>In-store Sales & Customer Service</li>
                <li>Basic Customer Loyalty</li>
                <li>Sales Performance Analytics</li>
            </ul>
        </div>
    </ModuleContainer>
);

// This ensures Tailwind CSS is loaded and applied
const TailwindCSS = () => (
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
);

// Main entry point for the React application in a production environment
// This component should not be directly rendered within the Canvas environment.
// It's illustrative of how the App component would be mounted in a real app.
/*
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(
  <React.StrictMode>
    <App />
  </React.StrictMode>
);
*/

